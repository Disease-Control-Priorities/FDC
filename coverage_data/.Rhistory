rm(list=ls())
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
pacman::p_load(dplyr, tidyr, ggplot2, boot)
rm(list=ls())
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
pacman::p_load(dplyr, tidyr, ggplot2, boot, data.table, tidyverse)
locs<-read.csv("Country_groupings_extended.csv", stringsAsFactors = F)%>%
select(gbd2019, iso3, wb2021, location_gbd, location_ncdrisc)%>%rename(location_name = gbd2019)
cascade2<-read.csv("../shiny/FDC/cascade.csv", stringsAsFactors = F)
cascade3<-read.csv("../shiny/FDC/cascade_aspirin.csv", stringsAsFactors = F)
aroc<-read.csv("NCD-RisC_Lancet_2021_Hypertension_crude_countries.csv", stringsAsFactors = F)%>%
rename(iso3 = ISO, year=Year)%>%
left_join(., locs)%>%
group_by(year,location_name, iso3)%>%
summarise(Treated = mean(Proportion.of.treated.hypertension.among.all.hypertension),
Aware = mean(Proportion.of.diagnosed.hypertension.among.all.hypertension),
Control = mean(Proportion.of.controlled.hypertension.among.all.hypertension))%>%
na.omit()%>%
filter(year>=2009)%>%
mutate(Adherence = Control/Treated,
Initiation = Treated/Aware)%>%
nest(-location_name, -iso3)%>%
mutate(aware_aroc = map(data, ~coef(lm(Aware ~ year, data=.x))[["year"]]),
adherence_aroc = map(data, ~coef(lm(Adherence ~ year, data=.x))[["year"]]),
initiation_aroc = map(data, ~coef(lm(Initiation ~ year, data=.x))[["year"]]),
treated_aroc = map(data, ~coef(lm(Treated ~ year, data=.x))[["year"]]),
control_aroc = map(data, ~coef(lm(Control ~ year, data=.x))[["year"]]))%>%
select(-data)%>%
unnest()%>%
mutate(aware_aroc = ifelse(aware_aroc<0, 0, aware_aroc),
adherence_aroc = ifelse(adherence_aroc<0, 0, adherence_aroc),
initiation_aroc = ifelse(initiation_aroc<0, 0, initiation_aroc),
treated_aroc = ifelse(treated_aroc<0, 0 , treated_aroc),
control_aroc = ifelse(control_aroc<0, 0 , control_aroc))
#warning ok
htn<-read.csv("NCD-RisC_Lancet_2021_Hypertension_crude_countries.csv", stringsAsFactors = F)%>%
rename(iso3 = ISO, year=Year)%>%
left_join(., locs)%>%
group_by(year,location_name, iso3)%>%
summarise(Treated = mean(Proportion.of.treated.hypertension.among.all.hypertension),
Aware = mean(Proportion.of.diagnosed.hypertension.among.all.hypertension),
Control = mean(Proportion.of.controlled.hypertension.among.all.hypertension))%>%
na.omit()
baselinePP<-cascade2%>%
left_join(.,aroc)%>%
merge(., data.frame(year=2017:2050))%>%
mutate(initiation_aroc = ifelse(initiation_aroc>0.005, 0.005, initiation_aroc),
adherence_aroc = ifelse(adherence_aroc>0.005, 0.005, adherence_aroc))%>%
mutate(Aware = ifelse(year<2023, pp_aware, 0.95 - (0.95-pp_aware)*exp(-aware_aroc*(year-2022))),
Aware = ifelse(year<2023, pp_aware, Aware + (year-2022)*aware_aroc),
Aware = ifelse(Aware>0.95, 0.95, Aware),
Initiation = ifelse(year<2023, pp_initiation, ((year-2022)*initiation_aroc + pp_initiation)),
Initiation = ifelse(Initiation>0.95 ,0.95, Initiation),
Treated = Aware * Initiation,
Adherence = ifelse(year<2023, pp_adherence,((year-2022)*adherence_aroc + pp_adherence)),
Adherence = ifelse(Adherence>0.95 ,0.95, Adherence),
Control = Treated*Adherence)%>%
select(location_name, iso3, cause, year, Aware, Treated, Control, Initiation, Adherence)
baselineSP<-cascade2%>%
left_join(.,aroc)%>%
merge(., data.frame(year=2017:2050))%>%
mutate(initiation_aroc = ifelse(initiation_aroc>0.005, 0.005, initiation_aroc),
adherence_aroc = ifelse(adherence_aroc>0.005, 0.005, adherence_aroc))%>%
mutate(Aware = ifelse(year<2023, sp_aware, 0.95 - (0.95-sp_aware)*exp(-aware_aroc*(year-2022))),
Aware = ifelse(year<2023, sp_aware, Aware + (year-2022)*aware_aroc),
Aware = ifelse(Aware>0.95, 0.95, Aware),
Initiation = ifelse(year<2023, sp_initiation, ((year-2022)*initiation_aroc + sp_initiation)),
Initiation = ifelse(Initiation>0.95 ,0.95, Initiation),
Treated = Aware * Initiation,
Adherence = ifelse(year<2023, sp_adherence,((year-2022)*adherence_aroc + sp_adherence)),
Adherence = ifelse(Adherence>0.95 ,0.95, Adherence),
Control = Treated*Adherence)%>%
select(location_name, iso3, cause, year, Aware, Treated, Control, Initiation, Adherence)
#
baselinePP_asp<-cascade3%>%
left_join(.,aroc)%>%
merge(., data.frame(year=2017:2050))%>%
mutate(initiation_aroc = ifelse(initiation_aroc>0.005, 0.005, initiation_aroc),
adherence_aroc = ifelse(adherence_aroc>0.005, 0.005, adherence_aroc))%>%
mutate(Aware = ifelse(year<2023, pp_aware, 0.95 - (0.95-pp_aware)*exp(-aware_aroc*(year-2022))),
Aware = ifelse(year<2023, pp_aware, Aware + (year-2022)*aware_aroc),
Aware = ifelse(Aware>0.95, 0.95, Aware),
Initiation = ifelse(year<2023, pp_initiation, ((year-2022)*initiation_aroc + pp_initiation)),
Initiation = ifelse(Initiation>0.95 ,0.95, Initiation),
Treated = Aware * Initiation,
Adherence = ifelse(year<2023, pp_adherence,((year-2022)*adherence_aroc + pp_adherence)),
Adherence = ifelse(Adherence>0.95 ,0.95, Adherence),
Control = Treated*Adherence)%>%
select(location_name, iso3, cause, year, Aware, Treated, Control, Initiation, Adherence)
baselineSP_asp<-cascade3%>%
left_join(.,aroc)%>%
merge(., data.frame(year=2017:2050))%>%
mutate(initiation_aroc = ifelse(initiation_aroc>0.005, 0.005, initiation_aroc),
adherence_aroc = ifelse(adherence_aroc>0.005, 0.005, adherence_aroc))%>%
mutate(Aware = ifelse(year<2023, sp_aware, 0.95 - (0.95-sp_aware)*exp(-aware_aroc*(year-2022))),
Aware = ifelse(year<2023, sp_aware, Aware + (year-2022)*aware_aroc),
Aware = ifelse(Aware>0.95, 0.95, Aware),
Initiation = ifelse(year<2023, sp_initiation, ((year-2022)*initiation_aroc + sp_initiation)),
Initiation = ifelse(Initiation>0.95 ,0.95, Initiation),
Treated = Aware * Initiation,
Adherence = ifelse(year<2023, sp_adherence,((year-2022)*adherence_aroc + sp_adherence)),
Adherence = ifelse(Adherence>0.95 ,0.95, Adherence),
Control = Treated*Adherence)%>%
select(location_name, iso3, cause, year, Aware, Treated, Control, Initiation, Adherence)
plot<-bind_rows(htn%>%filter(year<2017), baselinePP%>%group_by(location_name, iso3, year)%>%
summarise(Aware = mean(Aware),
Treated = mean(Treated),
Control = mean(Control)))
ggplot(plot, aes(x=year, y=Aware, groups=location_name))+
geom_line()+
xlim(2009,2050)
ggplot(baselinePP, aes(x=year, y=Initiation, groups=location_name))+
geom_line()+
facet_wrap(~cause)
ggplot(plot, aes(x=year, y=Treated, groups=location_name))+
geom_line()
ggplot(baselinePP, aes(x=year, y=Adherence, groups=location_name))+
geom_line()+
facet_wrap(~cause)
ggplot(plot, aes(x=year, y=Control, groups=location_name))+
geom_line()
#Average increase in baseline control rates?
#need to do population weighting**
pop<-read.csv("API_SP.POP.TOTL_DS2_en_csv_v2_5795797.csv", stringsAsFactors = F, skip=4)%>%
select(iso3 = Country.Code, pop = X2019)
baselinePP%>%filter(year %in% c(2022,2050))%>%
select(year, iso3, Control, cause)%>%
spread(year, Control)%>%
left_join(., pop)%>%
mutate(slope = (`2050` - `2022`)/(2050-2022))%>%
na.omit()%>%
summarise(rate = weighted.mean(slope, pop))
baselinePP_asp%>%filter(year %in% c(2022,2050))%>%
select(year, iso3, Control, cause)%>%
spread(year, Control)%>%
left_join(., pop)%>%
mutate(slope = (`2050` - `2022`)/(2050-2022))%>%
na.omit()%>%
summarise(rate = weighted.mean(slope, pop))
baselineSP%>%filter(year %in% c(2022,2050))%>%
select(year, iso3, Control, cause)%>%
spread(year, Control)%>%
left_join(., pop)%>%
mutate(slope = (`2050` - `2022`)/(2050-2022))%>%
na.omit()%>%
summarise(rate = weighted.mean(slope, pop))
baselineSP_asp%>%filter(year %in% c(2022,2050))%>%
select(year, iso3, Control, cause)%>%
spread(year, Control)%>%
left_join(., pop)%>%
mutate(slope = (`2050` - `2022`)/(2050-2022))%>%
na.omit()%>%
summarise(rate = weighted.mean(slope, pop))
